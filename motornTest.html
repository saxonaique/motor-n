<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Motor N - Sistema DIG</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: monospace;
      padding: 20px;
    }
    canvas {
      border: 1px solid #555;
      display: block;
      margin-bottom: 20px;
      width: 400px; 
      height: 400px;
    }
    #noutput-console, #log-output {
      padding: 1em;
      border-radius: 10px;
      font-size: 14px;
      white-space: pre-line;
    }
    #noutput-console {
      background: #000;
      color: #0f0;
    }
    #log-output {
      background: #222;
      color: #ccc;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 15px;
    }
    button {
      margin-top: 10px;
      padding: 0.5em 1em;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
    }
    #inject-btn { background: #0a0; color: white; border: none; }
    #animate-btn { background: #ff6600; color: white; border: none; }
    #reset-btn { background: #cc0000; color: white; border: none; }
    #export-btn { background-color: #007acc; color: white; border: none; }
    input[type="range"] { width: 200px; }
    label { color: #ccc; }
  </style>
</head>
<body>

<h2>üß† Motor N ‚Äì Simulaci√≥n Informacional DIG</h2>
<canvas id="campo" width="400" height="400"></canvas>

<button id="inject-btn" onclick="inyectarPatron('ansiedad')">üí• Inyectar patr√≥n: ansiedad</button>
<button id="animate-btn" onclick="toggleAnimacion()">‚ñ∂Ô∏è Iniciar Animaci√≥n</button>
<button id="reset-btn" onclick="resetearCampo()">üîÑ Reset Campo</button>
<button id="export-btn" onclick="exportarOutput()">üì§ Exportar Output como .json</button>

<div style="margin: 10px 0;">
  <label>Velocidad: </label>
  <input type="range" id="speed-slider" min="10" max="500" value="100" onchange="cambiarVelocidad(this.value)">
  <span id="speed-display">100ms</span>
</div>

<div id="noutput-console">üß† A√∫n no hay datos.</div>
<h3>üìú Historial de Outputs</h3>
<div id="log-output">Sin entradas a√∫n.</div>

<script>
  const ancho = 50;
  const alto = 50;
  let campo = [];
  let historialOutputs = [];
  let animando = false;
  let velocidadAnimacion = 100; // ms entre frames
  let ciclosTranscurridos = 0;
  let patronInyectado = false;

  // Inicializa el campo con valores aleatorios
  function inicializarCampo() {
    campo = Array.from({ length: alto }, () =>
      Array.from({ length: ancho }, () => Math.random() * 0.1)
    );
    ciclosTranscurridos = 0;
    patronInyectado = false;
  }

  // Inyecta un patr√≥n en una zona espec√≠fica
  function inyectarPatron(nombre) {
    const zona = {
      x: 21,
      y: 21,
      ancho: 7,
      alto: 7
    };

    // Actualiza valores en la zona
    for (let i = 0; i < zona.alto; i++) {
      for (let j = 0; j < zona.ancho; j++) {
        const y = zona.y + i;
        const x = zona.x + j;
        if (y < alto && x < ancho) {
          // Nuevo: Incrementa gradualmente en lugar de reemplazar
          campo[y][x] = Math.min(1, campo[y][x] + Math.random() * 0.3);
        }
      }
    }

    patronInyectado = true;
    ciclosTranscurridos = 0;
    
    const output = generarOutput(nombre, zona);
    mostrarOutputEnConsola(output);
    actualizarLog();
    renderizarCampo();
  }

  // Genera el output con m√©tricas del sistema
  function generarOutput(patron, zona) {
    let total = 0;
    let maxVal = 0;
    let maxPos = { x: 0, y: 0 };

    for (let y = 0; y < alto; y++) {
      for (let x = 0; x < ancho; x++) {
        const val = campo[y][x];
        total += val;
        if (val > maxVal) {
          maxVal = val;
          maxPos = { x, y };
        }
      }
    }

    const promedio = total / (ancho * alto);
    const varianza = calcularVarianza(promedio);

    return {
      timestamp: new Date().toISOString(),
      patron_inyectado: patron,
      modo_inyeccion: "acumulativo", // Modificado
      zona_afectada: zona,
      entropia_global: varianza,
      max_entropia: {
        valor: maxVal,
        posicion: maxPos
      },
      promedio_global: promedio,
      tiempo_disolucion_estimado: `${Math.floor(20 - promedio * 10)} ciclos`, // Din√°mico
      resonancia_detectada: varianza > 0.05, // Nueva l√≥gica
      exportado_como_audio: "no",
      notas: `Respuesta al patr√≥n '${patron}'. Intensidad: ${(maxVal * 100).toFixed(1)}%`
    };
  }

  // C√°lculo de varianza
  function calcularVarianza(promedio) {
    let sum = 0;
    for (let y = 0; y < alto; y++) {
      for (let x = 0; x < ancho; x++) {
        sum += Math.pow(campo[y][x] - promedio, 2);
      }
    }
    return sum / (ancho * alto);
  }

  // Renderiza el campo con escala mejorada
  function renderizarCampo() {
    const canvas = document.getElementById("campo");
    const ctx = canvas.getContext("2d");
    const escalaX = canvas.width / ancho;
    const escalaY = canvas.height / alto;

    // Limpiar canvas
    ctx.fillStyle = "#111";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Dibujar celdas
    for (let y = 0; y < alto; y++) {
      for (let x = 0; x < ancho; x++) {
        const val = campo[y][x];
        // Gradiente de color mejorado
        const r = Math.floor(val * 255);
        const g = Math.floor((1 - val) * 100);
        const b = Math.floor(val * 100);
        ctx.fillStyle = `rgb(${r},${g},${b})`;
        ctx.fillRect(x * escalaX, y * escalaY, escalaX, escalaY);
      }
    }

    // Dibujar cuadr√≠cula
    ctx.strokeStyle = "#333";
    ctx.lineWidth = 0.5;
    for (let x = 0; x <= ancho; x++) {
      ctx.beginPath();
      ctx.moveTo(x * escalaX, 0);
      ctx.lineTo(x * escalaX, canvas.height);
      ctx.stroke();
    }
    for (let y = 0; y <= alto; y++) {
      ctx.beginPath();
      ctx.moveTo(0, y * escalaY);
      ctx.lineTo(canvas.width, y * escalaY);
      ctx.stroke();
    }
  }

  // Muestra los datos en la consola
  function mostrarOutputEnConsola(output) {
    const consola = document.getElementById("noutput-console");
    consola.innerHTML = `
üß† <strong>Patr√≥n:</strong> ${output.patron_inyectado}
üìç <strong>Zona:</strong> (${output.zona_afectada.x},${output.zona_afectada.y}) ‚Äì ${output.zona_afectada.ancho}x${output.zona_afectada.alto}
üìä <strong>Entrop√≠a:</strong> ${output.entropia_global.toFixed(5)}
üî• <strong>Pico:</strong> (${output.max_entropia.posicion.x}, ${output.max_entropia.posicion.y}) ‚Üí ${output.max_entropia.valor.toFixed(5)}
üìà <strong>Promedio:</strong> ${output.promedio_global.toFixed(3)}
‚è≥ <strong>Disoluci√≥n:</strong> ${output.tiempo_disolucion_estimado}
üéµ <strong>Resonancia:</strong> ${output.resonancia_detectada ? '‚úÖ' : '‚ùå'}
üìå <strong>Notas:</strong> ${output.notas}
    `;
    historialOutputs.push(output);
  }

  // Actualiza el historial
  function actualizarLog() {
    const log = document.getElementById("log-output");
    log.innerHTML = historialOutputs.map((o, i) => {
      const fecha = new Date(o.timestamp).toLocaleTimeString();
      return `#${i + 1} [${fecha}] ‚Üí ${o.patron_inyectado} | Entrop√≠a: ${o.entropia_global.toFixed(5)} | Pico: ${o.max_entropia.valor.toFixed(5)}`;
    }).join('\n');
  }

  // Exporta los datos
  function exportarOutput() {
    if (historialOutputs.length === 0) {
      alert("No hay datos para exportar.");
      return;
    }

    const data = JSON.stringify(historialOutputs, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    link.href = url;
    link.download = `noutput_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Evoluciona el campo usando reglas de aut√≥mata celular
  function evolucionarCampo() {
    let nuevoCampo = JSON.parse(JSON.stringify(campo));

    for (let y = 1; y < alto - 1; y++) {
      for (let x = 1; x < ancho - 1; x++) {
        let sumaVecinos =
          campo[y - 1][x] +
          campo[y + 1][x] +
          campo[y][x - 1] +
          campo[y][x + 1] +
          campo[y - 1][x - 1] +
          campo[y - 1][x + 1] +
          campo[y + 1][x - 1] +
          campo[y + 1][x + 1];

        let promedio = sumaVecinos / 8;
        
        // Reglas de evoluci√≥n
        if (campo[y][x] > 0.8) {
          nuevoCampo[y][x] = campo[y][x] * 0.95; // Decaimiento alto
        } else if (campo[y][x] < 0.1) {
          nuevoCampo[y][x] = Math.min(0.3, campo[y][x] + promedio * 0.1); // Crecimiento lento
        } else {
          nuevoCampo[y][x] = (campo[y][x] * 0.9) + (promedio * 0.1); // Difusi√≥n
        }
        
        // Mantener en rango [0, 1]
        nuevoCampo[y][x] = Math.max(0, Math.min(1, nuevoCampo[y][x]));
      }
    }

    campo = nuevoCampo;
    ciclosTranscurridos++;
  }

  // Controla la animaci√≥n
  function toggleAnimacion() {
    const btn = document.getElementById('animate-btn');
    
    if (animando) {
      animando = false;
      btn.textContent = '‚ñ∂Ô∏è Iniciar Animaci√≥n';
      btn.style.background = '#ff6600';
    } else {
      animando = true;
      btn.textContent = '‚è∏Ô∏è Pausar Animaci√≥n';
      btn.style.background = '#ff3300';
      cicloAnimacion();
    }
  }

  // Ciclo principal de animaci√≥n
  function cicloAnimacion() {
    if (!animando) return;
    
    evolucionarCampo();
    renderizarCampo();
    
    // Actualizar informaci√≥n en tiempo real
    if (patronInyectado && ciclosTranscurridos % 20 === 0) {
      const zona = { x: 21, y: 21, ancho: 7, alto: 7 };
      const output = generarOutput('evoluci√≥n', zona);
      mostrarOutputEnConsola(output);
    }
    
    setTimeout(cicloAnimacion, velocidadAnimacion);
  }

  // Resetea el campo
  function resetearCampo() {
    inicializarCampo();
    renderizarCampo();
    document.getElementById('noutput-console').innerHTML = 'üß† Campo reseteado.';
  }

  // Cambia la velocidad de animaci√≥n
  function cambiarVelocidad(valor) {
    velocidadAnimacion = parseInt(valor);
    document.getElementById('speed-display').textContent = valor + 'ms';
  }

  // Inicializar
  inicializarCampo();
  renderizarCampo();
</script>
</body>
</html>
